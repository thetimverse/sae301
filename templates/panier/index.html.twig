{% extends 'base.html.twig' %}

{% block title %}Panier - SAÉ301{% endblock %}

{% block body %}
    <section id="main">
        <h1>Votre panier</h1>
        <div id="cart">
            <table>
                <thead>
                    <th colspan=2><h3>Évènement(s)</h3></th>
                    <th><h3>Quantité</h3></th>
                    <th><h3>Prix unitaire</h3></th>
                    <th><h3>Prix total</h3></th>
                </thead>
                <tbody id="zone">

                </tbody>
            </table>
            <h2><span>Total :</span><span id="total"> 0</span>€</h2>

        </div>
        
        <div id="bttn">
            <a href="{{ path('app_accueil')}}" class="bttn-secondary">Annuler</a>
            <input type="hidden" name="liste" id="liste">
            <a href="#" class="bttn-primary">Effectuer la commande</a>
        </div>
    </section>
    <script>
        liste = document.cookie //recupere le cookie  sous forme de chaine de caractere 
        if (liste!="")montab = JSON.parse(liste) // transforme la chaine  en tableau JSON
        else montab =Array() // si il n'y a pas de tableau dans le cookie alors créer le tableau
        console.log(montab)

        document.getElementById('liste').value=JSON.stringify(montab); // sauver montab pour le formulaire

        var totalgeneral=0
        montab.forEach(manif => {  

            html = `<tr id="${manif.id}">
                        
                        <td class="infos"><h3>${manif.titre}</h3><br><h4>${manif.date} - ${manif.horaire}</h4></td>
                        <td id="quantite">
                            <div><i class="material-icons moins">remove_circle</i><span>${manif.quantite}</span><i class="material-icons plus">add_circle</i></div> 
                        </td>
                        <td><span class="unitaire">${manif.prix} €</span></td>
                        <td><span class="prix">${manif.prix * manif.quantite} €</span></td>
                    </tr>`;

            document.getElementById('zone').innerHTML += html
            totalgeneral += uneinfo.prix * uneinfo.quantite
        })

        document.getElementById('total').innerHTML = totalgeneral

        document.querySelectorAll('.plus').forEach(clickplus)
            
        function clickplus(tag){
            tag.addEventListener('click',function() { 
            qte=this.parentNode.querySelector('span').innerHTML;
            qte++;
            this.parentNode.querySelector('span').innerHTML=qte;
            prix=this.parentNode.parentNode.querySelector('.unitaire').innerHTML;
            total= prix*qte;
            this.parentNode.parentNode.querySelector('.prix').innerHTML=total;

            id = this.parentNode.parentNode.id; // recupere l'id de l'article cliqué
            index = montab.findIndex(element => element.id ==id); //trouver l'article dans la liste du panier
            montab[index].quantite	= parseInt(montab[index].quantite) +1; //incrementer la quantité
            document.cookie = JSON.stringify(montab);  // sauvegarde des infos dans le cookie "liste"

            totalgeneral += parseInt(prix)
            document.querySelector('#total').innerHTML=totalgeneral

        })}

        document.querySelectorAll('.moins').forEach(clickmoins)
            
        function clickmoins(tag){
            tag.addEventListener('click',function() { 
            qte=this.parentNode.querySelector('span').innerHTML;
            if( qte>0){
            qte--
            this.parentNode.querySelector('span').innerHTML=qte;
            prix=this.parentNode.parentNode.querySelector('.unitaire').innerHTML;
            total= prix*qte;
            this.parentNode.parentNode.querySelector('.prix').innerHTML=total;

            id = this.parentNode.parentNode.id; // recupere l'id de l'article cliqué
            index = montab.findIndex(element => element.id ==id); //trouver l'article dans la liste du panier
            montab[index].quantite	= parseInt(montab[index].quantite) -1; //incrementer la quantité

            console.log(montab)
            document.cookie = JSON.stringify(montab);  // sauvegarde des infos dans le cookie "liste"

            totalgeneral -= parseInt(prix)
            document.querySelector('#total').innerHTML=totalgeneral
            }

        })}  
    </script>
{% endblock %}